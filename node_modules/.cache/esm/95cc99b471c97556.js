let Product,multer,path,CustomErrorHandler,Joi,fs,nextTick;_71c‍.x([["default",()=>_71c‍.o]]);_71c‍.w("../models",[["Product",["Product"],function(v){Product=v}]]);_71c‍.w("multer",[["default",["multer"],function(v){multer=v}]]);_71c‍.w("path",[["default",["path"],function(v){path=v}]]);_71c‍.w("../services/CustomErrorHandler",[["default",["CustomErrorHandler"],function(v){CustomErrorHandler=v}]]);_71c‍.w("joi",[["default",["Joi"],function(v){Joi=v}]]);_71c‍.w("fs",[["default",["fs"],function(v){fs=v}]]);_71c‍.w("process",[["nextTick",["nextTick"],function(v){nextTick=v}]]);






// define storage 

const storage = multer.diskStorage({
    destination : (req , file , cb)=>cb(null , 'uploads/'),
    filename: (req , file , cb)=>{
        const uniqueName = `${Date.now()}-${Math.round(Math.random()*1E9)}${path.extname(file.originalname)}`
        cb(null , uniqueName)
    }
    
})

const handleMatipartData = multer({storage , limits:{fileSize:1000000*5}}).single('image')

const productController = {
    async store(req , res , next){
    
        // Multipart-form data
        handleMatipartData(req,res , async(err)=>{
            if(err){
                return next(CustomErrorHandler.serverError(err.message))
            }

            const filePath = req.file.path

            // validation 

            const productsSchema = Joi.object({
             name : Joi.string().required(),
             price: Joi.number().required(),
             size: Joi.string().required(),
            })
   

            const {error} = productsSchema.validate(req.body)

            if(error)
            {
                // image already uploaded to the server  before validate unnecessary upload could be taken
                // so that's why  Delete that file

                fs.unlink(`${appRoot}/${filePath}` , (err)=>{
                    return next(CustomErrorHandler.serverError(err.message))
                })
                return next(error)
            }

            //console.log(filePath)


           // if everything is fine

           const {name , price , size} = req.body
           let document;

           try{
               document = await Product.create({
                   name,
                   price , 
                   size,
                   image : filePath
               })
           }
           catch(err)
           {
             return next(err)
           }

   

            res.status(201).json(document)    // 201 sucessful creation in the server 

        })


    }
}

_71c‍.d(productController);
